<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Кошик</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <style>
      /* Базовые стили */
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        overflow: hidden;
        overflow-y: auto;
      }
      /* Стили для фонового видео */
      #background-video {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: -1;
      }
      /* Основной контейнер */
      .container-wrapper {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        gap: 20px;
        margin-top: 50px;
        padding: 20px;
      }
      /* Стили для секций корзины и авторизации */
      .cart-container {
        flex: 2;
        background: rgba(255, 255, 255, 0.85); /* Полупрозрачный фон */
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      }
      .auth-container {
        flex: 1;
        background: rgba(255, 255, 255, 0.85);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      }
      /* Анимация для счетчика корзины */
      @keyframes bounce {
        0% {
          transform: translateY(0);
        }
        30% {
          transform: translateY(-10px);
        }
        60% {
          transform: translateY(0);
        }
        100% {
          transform: translateY(0);
        }
      }
      .bounce {
        animation: bounce 0.5s;
      }
    </style>
  </head>

  <body>
    <video id="background-video" autoplay loop muted>
      <source src="CoffeeVideo.mp4" type="video/mp4" />
      Ваш браузер не підтримує відео.
    </video>

    <div class="container-wrapper">
      <div class="cart-container">
        <h2 class="text-center">Кошик покупок</h2>
        <div id="cart-items" class="mb-3"></div>

        <p id="cart-quantity" class="fw-bold text-end">Всього товарів: 0</p>
        <p id="cart-total" class="fw-bold text-end">Всього: 0₴</p>
        <div class="text-end">
          <button class="btn btn-danger" id="clear-cart">Очистити кошик</button>
        </div>
      </div>

      <div class="auth-container">
        <h2 class="text-center">Форма авторизації</h2>
        <form id="auth-form">
          <div class="mb-3">
            <label for="full-name" class="form-label">Прізвище та Ім'я</label>
            <input type="text" class="form-control" id="full-name" required />
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">E-mail</label>
            <input type="email" class="form-control" id="email" required />
          </div>
          <div class="mb-3">
            <label for="address" class="form-label">Адреса</label>
            <input type="text" class="form-control" id="address" required />
          </div>
          <div class="mb-3 form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="postal-service"
            />
            <label class="form-check-label" for="postal-service"
              >Оформити послугу поштової доставки</label
            >
          </div>
          <div class="mb-3">
            <label for="payment-method" class="form-label">Спосіб оплати</label>
            <select class="form-select" id="payment-method">
              <option value="card">Банківська карта</option>
              <option value="cash">Готівка при отриманні</option>
            </select>
          </div>
        </form>
      </div>
    </div>

    <script>
      /**
       * Обновляет число в красном кружочке иконки корзины.
       */
      function updateCartIcon() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        let totalQuantity = 0;
        cart.forEach((item) => {
          totalQuantity += parseInt(item.quantity) || 0;
        });

        const cartIcon = document.getElementById("cart-count");

        if (cartIcon) {
          cartIcon.textContent = totalQuantity;
          cartIcon.classList.remove("bounce");
          void cartIcon.offsetWidth;
          cartIcon.classList.add("bounce");
        }
      }
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const PROXY_URL =
          "https://ukrethnodumpcrm-proxy-v2-877954628151.europe-central2.run.app";

        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        const cartContainer = document.getElementById("cart-items");
        const cartTotal = document.getElementById("cart-total");
        const cartQuantity = document.getElementById("cart-quantity");

        // --- Обновление корзины ---
        function updateCart() {
          cartContainer.innerHTML = "";
          let total = 0;
          let totalQuantity = 0;

          if (cart.length === 0) {
            cartContainer.innerHTML =
              "<p class='text-center'>Ваш кошик порожній.</p>";
          } else {
            cart.forEach((item, index) => {
              const itemPrice = parseFloat(item.price) || 0;
              const itemQuantity = parseInt(item.quantity) || 0;

              if (!itemPrice || !itemQuantity) return;

              total += itemPrice * itemQuantity;
              totalQuantity += itemQuantity;

              cartContainer.innerHTML += `
        <div class="card mb-3" data-index="${index}">
          <div class="row g-0">
            <div class="col-md-4">
              <img src="${item.image}" class="img-fluid" alt="${item.name}">
            </div>
            <div class="col-md-8">
              <div class="card-body">
                <h5 class="card-title">${item.name}</h5>
                <p class="card-text">Ціна: ${item.price}₴ x ${item.quantity}</p>
                <p class="card-text">Розмір: ${item.size || "—"}</p>

                <div class="d-flex align-items-center">
                  <button class="btn btn-outline-secondary btn-sm me-2 decrease-qty" data-index="${index}">-</button>
                  <span class="quantity-value">${item.quantity}</span>
                  <button class="btn btn-outline-secondary btn-sm ms-2 increase-qty" data-index="${index}">+</button>
                </div>

                <button class="btn btn-danger btn-sm mt-2 remove-item" data-index="${index}">Видалити</button>
              </div>
            </div>
          </div>
        </div>`;
            });
          }

          cartTotal.textContent = `Всього: ${total}₴`;
          cartQuantity.textContent = `Всього товарів: ${totalQuantity}`;

          updateCartIcon();
          bindCartActions();
        }

        // --- Привязка кнопок внутри корзины ---
        function bindCartActions() {
          document.querySelectorAll(".remove-item").forEach((btn) => {
            btn.addEventListener("click", function () {
              const index = this.dataset.index;
              cart.splice(index, 1);
              localStorage.setItem("cart", JSON.stringify(cart));
              updateCart();
            });
          });

          document.querySelectorAll(".increase-qty").forEach((btn) => {
            btn.addEventListener("click", function () {
              const index = this.dataset.index;
              cart[index].quantity++;
              localStorage.setItem("cart", JSON.stringify(cart));
              updateCart();
            });
          });

          document.querySelectorAll(".decrease-qty").forEach((btn) => {
            btn.addEventListener("click", function () {
              const index = this.dataset.index;
              if (cart[index].quantity > 1) {
                cart[index].quantity--;
                localStorage.setItem("cart", JSON.stringify(cart));
                updateCart();
              }
            });
          });
        }

        // --- Очистка корзины ---
        document
          .getElementById("clear-cart")
          .addEventListener("click", function () {
            localStorage.removeItem("cart");
            cart = [];
            updateCart();
          });

        // --- УДАЛЯЕМ ВСТРОЕННУЮ ЛОГИКУ submit ФОРМЫ (чтобы избежать дублирования) ---
        const authForm = document.getElementById("auth-form");
        if (authForm) {
          authForm.addEventListener("submit", function (ev) {
            ev.preventDefault();
            // Ничего не делаем, вся логика в confirmOrderBtn
          });
        }

        // Код для кнопки "Подтвердить замовлення"
        const confirmOrderBtn = document.createElement("button");
        confirmOrderBtn.className = "btn btn-success mt-3";
        confirmOrderBtn.textContent = "Підтвердити замовлення";
        confirmOrderBtn.id = "confirm-order-btn";
        // Вставляем кнопку в контейнер авторизации
        document.querySelector(".auth-container").appendChild(confirmOrderBtn);

        confirmOrderBtn.addEventListener("click", function (event) {
          event.preventDefault();
          event.stopPropagation();
          if (cart.length === 0) {
            alert("Кошик порожній!");
            return;
          }
          if (confirmOrderBtn.disabled) return;

          confirmOrderBtn.disabled = true;
          confirmOrderBtn.textContent = "Відправка...";

          // 1. ЧТЕНИЕ ВСЕХ ДАННЫХ КЛИЕНТА ИЗ ФОРМЫ
          const customerName =
            document.getElementById("full-name")?.value.trim() || "";
          const customerEmail =
            document.getElementById("email")?.value.trim() || "";
          const customerAddress =
            document.getElementById("address")?.value.trim() || "";
          const paymentMethod =
            document.getElementById("payment-method")?.value || "";
          const postalService = document.getElementById("postal-service")
            ?.checked
            ? "Так"
            : "Ні";

          // 2. Запрашиваем телефон (ОДИН РАЗ)
          const customerPhone = prompt(
            "Введіть ваш номер телефону для замовлення:"
          );

          if (!customerPhone || customerPhone.trim() === "") {
            alert("Номер телефону обов'язковий для оформлення замовлення!");
            confirmOrderBtn.disabled = false;
            confirmOrderBtn.textContent = "Підтвердити замовлення";
            return;
          }

          // 3. ШАГ 1: ОТПРАВКА ДАННЫХ КЛИЕНТА (Один раз в Clients/List #2)
          const clientData = {
            action: "client", // Для Clients (List #2)
            name: customerName,
            email: customerEmail,
            address: customerAddress,
            phone: customerPhone.trim(),
            postalService: postalService,
            paymentMethod: paymentMethod,
          };

          const clientPromise = fetch(PROXY_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(clientData),
          });

          // 4. ШАГ 2: ОТПРАВКА ДАННЫХ ЗАКАЗА (N раз в Orders/List #1)
          let orderPromises = cart.map((item) => {
            const orderData = {
              action: "order", // Для Orders (List #1)
              name: item.name,
              price: item.price,
              size: item.size,
              quantity: item.quantity,
              image: item.image,
              phone: customerPhone.trim(),
              email: customerEmail.trim(),
            };

            return fetch(PROXY_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify(orderData),
            });
          });

          // 5. Ждем завершения всех запросов
          Promise.all([clientPromise, ...orderPromises])
            .then((responses) => Promise.all(responses.map((r) => r.text())))
            .then((results) => {
              alert(
                "Замовлення та дані клієнта відправлено успішно! Чекайте на дзвінок."
              );
              localStorage.removeItem("cart");
              cart = [];
              updateCart();
              document.getElementById("auth-form")?.reset();
            })
            .catch((err) => {
              console.error("Помилка при надсиланні даних:", err);
              alert("Помилка відправки замовлення. Перевірте консоль.");
            })
            .finally(() => {
              confirmOrderBtn.disabled = false;
              confirmOrderBtn.textContent = "Підтвердити замовлення";
            });
        });

        // Инициализация
        updateCart();
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
